<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secret To Do List</title>
    <style>
      /* ê¸°ë³¸ì ìœ¼ë¡œ ì•± í™”ë©´ì€ ìˆ¨ê¹€ */
      #app-container {
        display: none;
      }

      /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
      #login-container {
        text-align: center;
        margin-top: 100px;
      }

      .delete {
        margin-left: 20px;
        cursor: pointer;
        color: red;
      }
      ol li {
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div id="login-container">
      <h1>ğŸ“ To do list</h1>
      <h2>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h2>
      <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <button id="login-btn">ì ‘ì†í•˜ê¸°</button>
      <p id="login-msg" style="color: red"></p>
    </div>

    <div id="app-container">
      <h1>ğŸ“ To do list</h1>
      <input type="text" id="text" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="add">ì¶”ê°€í•˜ê¸°</button>
      <button id="logout-btn" style="float: right">ë¡œê·¸ì•„ì›ƒ</button>
      <ol id="list"></ol>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      // ì¸ì¦(Auth) ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€ (getAuth, signInWithEmailAndPassword, signOut)
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD4hfd0NRQbtGAUIlnAlESVP3pc_pA-er8",
        authDomain: "todo-backend-ddac0.firebaseapp.com",
        projectId: "todo-backend-ddac0",
        storageBucket: "todo-backend-ddac0.firebasestorage.app",
        messagingSenderId: "347023087526",
        appId: "1:347023087526:web:4f72a5401e59e02ccb2167",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app); // ì¸ì¦ ì´ˆê¸°í™”

      // --- DOM ìš”ì†Œ ì„ íƒ ---
      const loginContainer = document.querySelector("#login-container");
      const appContainer = document.querySelector("#app-container");
      const passwordInput = document.querySelector("#password-input");
      const loginBtn = document.querySelector("#login-btn");
      const loginMsg = document.querySelector("#login-msg");
      const logoutBtn = document.querySelector("#logout-btn");

      const textEl = document.querySelector("#text");
      const addBtn = document.querySelector("#add");
      const listEl = document.querySelector("#list");

      // ğŸ’¡ [í•µì‹¬] ê³µìš© ì´ë©”ì¼ ì„¤ì • (ì‚¬ìš©ìì—ê²ŒëŠ” ë¹„ë°€ë²ˆí˜¸ë§Œ ì…ë ¥ë°›ìŒ)
      const SHARED_EMAIL = "admin@todo.com";

      // --- ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ---

      // 1. ë¡œê·¸ì¸ ì²˜ë¦¬
      const handleLogin = async () => {
        const password = passwordInput.value;
        try {
          // ì´ë©”ì¼ì€ ê³ ì •í•´ë‘ê³ , ì…ë ¥ë°›ì€ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì‹œë„
          await signInWithEmailAndPassword(auth, SHARED_EMAIL, password);
          // ì„±ê³µí•˜ë©´ onAuthStateChangedê°€ ê°ì§€í•˜ì—¬ í™”ë©´ ì „í™˜í•¨
          passwordInput.value = "";
          loginMsg.textContent = "";
        } catch (error) {
          console.error(error);
          loginMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!";
        }
      };

      // 2. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
      logoutBtn.addEventListener("click", () => {
        signOut(auth);
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });

      // 3. ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (ë¡œê·¸ì¸ ë˜ë©´ í™”ë©´ ì „í™˜ ë° ë°ì´í„° ë¡œë“œ)
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // ë¡œê·¸ì¸ ë¨
          loginContainer.style.display = "none";
          appContainer.style.display = "block";
          loadTodos(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
        } else {
          // ë¡œê·¸ì•„ì›ƒ ë¨
          loginContainer.style.display = "block";
          appContainer.style.display = "none";
          listEl.innerHTML = ""; // ë³´ì•ˆì„ ìœ„í•´ ëª©ë¡ ë¹„ìš°ê¸°
        }
      });

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      loginBtn.addEventListener("click", handleLogin);
      passwordInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") handleLogin();
      });

      // --- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---

      const loadTodos = async () => {
        listEl.innerHTML = "";
        try {
          const q = query(collection(db, "todos"), orderBy("createdAt", "asc"));
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach((doc) => {
            renderTodoItem(doc.id, doc.data().text);
          });
        } catch (e) {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ê¶Œí•œ ì—†ìŒ):", e);
        }
      };

      const renderTodoItem = (id, text) => {
        const liEl = document.createElement("li");
        const spanEl = document.createElement("span");
        const deleteBtn = document.createElement("button");
        spanEl.textContent = text;
        deleteBtn.textContent = "ì™„ë£Œ";
        deleteBtn.classList.add("delete");
        deleteBtn.setAttribute("data-id", id);
        liEl.append(spanEl, deleteBtn);
        listEl.append(liEl);
      };

      const addTodoItem = async () => {
        const text = textEl.value.trim();
        if (!text) return;
        try {
          await addDoc(collection(db, "todos"), {
            text: text,
            completed: false,
            createdAt: serverTimestamp(),
          });
          textEl.value = "";
          loadTodos();
        } catch (e) {
          alert("ì €ì¥ ì‹¤íŒ¨!");
        }
      };

      const deleteTodo = async (id) => {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          await deleteDoc(doc(db, "todos", id));
          loadTodos();
        } catch (e) {
          alert("ì‚­ì œ ì‹¤íŒ¨!");
        }
      };

      addBtn.addEventListener("click", addTodoItem);
      textEl.addEventListener("keyup", (e) => {
        if (e.key === "Enter") addTodoItem();
      });
      listEl.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete")) deleteTodo(e.target.getAttribute("data-id"));
      });
    </script>
  </body>
</html>
